<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Share Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #0d1117;
      color: #c9d1d9;
    }
    header {
      background: #161b22;
      padding: 1rem;
      border-radius: 8px;
      margin: 20px;
    }
    .share-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #c9d1d9;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .share-btn:hover {
      background: #ffab6b;
      color: #0d1117;
      border-color: #ffab6b;
    }
    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 20px;
    }
    .qr-grid figure {
      background: #161b22;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .qr-grid img {
      width: 100%;
      max-width: 150px;
      height: auto;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .qr-grid img.expanded {
      transform: scale(1.5);
      z-index: 1000;
      position: relative;
    }
    .qr-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 999;
      display: none;
    }
    body.qr-expanded .qr-overlay {
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <h1>Final Share Test - Exact Copy</h1>
    <button class="share-btn" id="shareBtn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z" fill="currentColor"/>
      </svg>
      Share
    </button>
  </header>

  <div class="qr-grid" aria-label="QR codes">
    <div class="qr-overlay"></div>
    <figure>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=10&data=https://serbinov.github.io/" alt="QR code" loading="lazy" />
      <figcaption>Website QR</figcaption>
    </figure>
    <figure>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=10&data=https://github.com/serbinov" alt="QR code" loading="lazy" />
      <figcaption>GitHub QR</figcaption>
    </figure>
  </div>

  <script>
    console.log('Final test script loaded');

    // Global click handler for closing expanded elements
    document.addEventListener('click', (e) => {
      console.log('Global click detected:', e.target.tagName, e.target.className);

      // CRITICAL: Check if share modal exists and is active
      const shareModal = document.querySelector('.share-modal');
      if (shareModal && shareModal.dataset.shareModalActive === 'true') {
        console.log('Share modal is active - COMPLETELY IGNORING global click');
        return;
      }

      // Don't close if clicking inside share modal
      if (e.target.closest('.share-modal')) {
        console.log('Click inside share modal - ignoring');
        return;
      }

      // Close expanded QR codes
      if (!e.target.closest('.qr-grid img') && !e.target.closest('.qr-overlay')) {
        console.log('Attempting to close expanded QR codes');
        const expandedQr = document.querySelector('.qr-grid img.expanded');
        if (expandedQr) {
          expandedQr.classList.remove('expanded');
          document.body.classList.remove('qr-expanded');
          console.log('QR codes closed');
        }
      }
    });

    // QR Code expansion functionality
    const qrImages = document.querySelectorAll('.qr-grid img');
    qrImages.forEach(img => {
      img.addEventListener('click', (e) => {
        console.log('QR image clicked');
        e.preventDefault();

        // If another QR is expanded, close it first
        const expandedQr = document.querySelector('.qr-grid img.expanded');
        if (expandedQr && expandedQr !== img) {
          expandedQr.classList.remove('expanded');
        }

        // Toggle expanded state for clicked QR
        img.classList.toggle('expanded');

        // Toggle body class for overlay
        const hasExpanded = document.querySelector('.qr-grid img.expanded');
        document.body.classList.toggle('qr-expanded', !!hasExpanded);
      });
    });

    // Share button functionality
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) {
      shareBtn.addEventListener('click', async (e) => {
        console.log('Share button clicked - starting process');
        e.preventDefault();
        e.stopPropagation();

        const shareData = {
          title: 'Test Share',
          text: 'Testing share functionality.',
          url: window.location.href
        };

        // Always show fallback for testing
        showShareFallback(shareData);
      });
    }

    // Function to show fallback share options
    function showShareFallback(shareData) {
      console.log('Creating share modal with enhanced protection');

      // Remove any existing share modal
      const existingModal = document.querySelector('.share-modal');
      if (existingModal) {
        console.log('Removing existing modal');
        existingModal.remove();
      }

      const shareUrls = {
        twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareData.text)}&url=${encodeURIComponent(shareData.url)}`,
        linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareData.url)}`,
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareData.url)}`,
        telegram: `https://t.me/share/url?url=${encodeURIComponent(shareData.url)}&text=${encodeURIComponent(shareData.text)}`
      };

      const modal = document.createElement('div');
      modal.className = 'share-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: auto;
      `;
      modal.innerHTML = `
        <div class="share-modal-overlay">
          <div class="share-modal-content">
            <h3>Share this website</h3>
            <div class="share-links">
              <a href="${shareUrls.twitter}" target="_blank" class="share-link twitter">Twitter</a>
              <a href="${shareUrls.linkedin}" target="_blank" class="share-link linkedin">LinkedIn</a>
              <a href="${shareUrls.facebook}" target="_blank" class="share-link facebook">Facebook</a>
              <a href="${shareUrls.telegram}" target="_blank" class="share-link telegram">Telegram</a>
            </div>
            <button class="share-modal-close">Close</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      console.log('Modal added to DOM');

      // CRITICAL: Add protection flags
      modal.dataset.shareModalActive = 'true';
      modal.dataset.preventClose = 'true';

      // Add event listeners after modal is added to DOM
      const closeBtn = modal.querySelector('.share-modal-close');
      const overlay = modal.querySelector('.share-modal-overlay');

      const closeModal = (e) => {
        console.log('Closing modal via user action');
        if (e) {
          e.preventDefault();
          e.stopPropagation();
        }
        modal.dataset.shareModalActive = 'false';
        modal.dataset.preventClose = 'false';
        modal.style.opacity = '0';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.remove();
            console.log('Modal successfully removed');
          }
        }, 300);
      };

      closeBtn.addEventListener('click', (e) => {
        console.log('Close button clicked');
        closeModal(e);
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          console.log('Overlay clicked');
          closeModal(e);
        }
      });

      // Prevent clicks inside modal from bubbling up
      const modalContent = modal.querySelector('.share-modal-content');
      modalContent.addEventListener('click', (e) => {
        console.log('Modal content clicked - stopping propagation');
        e.stopPropagation();
      });

      // Add Escape key handler specifically for this modal
      const handleEscape = (e) => {
        if (e.key === 'Escape' && modal.dataset.shareModalActive === 'true') {
          console.log('Escape pressed - closing modal');
          closeModal(e);
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);

      // Animate modal appearance with protection
      setTimeout(() => {
        if (modal.dataset.preventClose !== 'false') {
          modal.style.opacity = '1';
          console.log('Modal opacity set to 1 - FULLY ACTIVE');
        }
      }, 100);

      // Additional protection - prevent any accidental closes for first 500ms
      setTimeout(() => {
        if (modal.dataset.shareModalActive === 'true') {
          console.log('Modal protection period ended - modal should be stable now');
        }
      }, 500);
    }
  </script>

  <style>
    /* Share modal styles */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: auto;
    }

    .share-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      cursor: pointer;
    }

    .share-modal-content {
      background: #161b22;
      padding: 2rem;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transform: scale(0.9);
      transition: transform 0.3s ease;
      cursor: default;
      pointer-events: auto;
    }

    .share-modal h3 {
      color: #c9d1d9;
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .share-links {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .share-link {
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: transform 0.2s ease, opacity 0.2s ease;
      display: inline-block;
      min-width: 80px;
    }

    .share-link:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .share-link.twitter { background: #1da1f2; }
    .share-link.linkedin { background: #0077b5; }
    .share-link.facebook { background: #1877f2; }
    .share-link.telegram { background: #0088cc; }

    .share-modal-close {
      background: #30363d;
      color: #c9d1d9;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s ease;
    }

    .share-modal-close:hover {
      background: #21262d;
    }

    .share-modal[style*="opacity: 1"] .share-modal-content {
      transform: scale(1);
    }
  </style>
</body>
</html>
